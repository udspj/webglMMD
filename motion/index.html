<html>
	<head>
		<title>miku</title>
		<meta charset="utf-8">
		<style>
			body { margin: 0; background-color: #000;}
		</style>
		<script src="js/three.min.js"></script>
		<script src="js/mmdparser.min.js"></script>
		<script src="js/jquery-3.3.1.min.js"></script>
		<script src="js/loaders/MMDLoader.js"></script>
		<script src="js/animation/MMDAnimationHelper.js"></script>
		<script src="js/animation/CCDIKSolver.js"></script>
		<script src="js/animation/MMDPhysics.js"></script>
		<script src="js/libs/ammo.js"></script>
	</head>
	<body>
		<div id="miku1"></div>
		<div id="miku2"></div>
		<div id="miku3"></div>
		<div id="miku4"></div>
		<button type="button" onclick="changeMotion(0)">look</button>
		<button type="button" onclick="changeMotion(1)">sleep</button>
		<button type="button" onclick="changeMotion(3)">up</button>
		<button type="button" onclick="changeMotion(4)">walk</button>
		<script>

			var scene = new THREE.Scene();
			var camera1 = new THREE.PerspectiveCamera( 75, 1, 0.1, 1000 );
			camera1.position.z = 20;
			camera1.position.y = 10;
			camera1.rotation.order = 'YXZ';
			camera1.rotateOnAxis((new THREE.Vector3(0, 0, 1)).normalize(), degInRad(180));
			var camera2 = new THREE.PerspectiveCamera( 75, 1, 0.1, 1000 );
			camera2.position.z = -20;
			camera2.position.y = 10;
			camera2.lookAt(new THREE.Vector3 (0.0, 10.0, 0.0));
			var camera3 = new THREE.PerspectiveCamera( 75, 1, 0.1, 1000 );
			camera3.position.z = 0;
			camera3.position.y = 10;
			camera3.position.x = 20;
			camera3.lookAt(new THREE.Vector3 (0.0, 10.0, 0.0));
			camera3.rotation.order = 'YXZ';
			camera3.rotateOnAxis((new THREE.Vector3(0, 0, 1)).normalize(), degInRad(90));
			var camera4 = new THREE.PerspectiveCamera( 75, 1, 0.1, 1000 );
			camera4.position.z = 0;
			camera4.position.y = 10;
			camera4.position.x = -20;
			camera4.lookAt(new THREE.Vector3 (0.0, 10.0, 0.0));
			camera4.rotation.order = 'YXZ';
			camera4.rotateOnAxis((new THREE.Vector3(0, 0, 1)).normalize(), degInRad(-90));

			var renderer1 = new THREE.WebGLRenderer();
			renderer1.setSize( window.innerHeight*0.4, window.innerHeight*0.4 );
			document.getElementById("miku1").appendChild( renderer1.domElement );
			var renderer2 = new THREE.WebGLRenderer();
			renderer2.setSize( window.innerHeight*0.4, window.innerHeight*0.4 );
			document.getElementById("miku2").appendChild( renderer2.domElement );
			var renderer3 = new THREE.WebGLRenderer();
			renderer3.setSize( window.innerHeight*0.4, window.innerHeight*0.4 );
			document.getElementById("miku3").appendChild( renderer3.domElement );
			var renderer4 = new THREE.WebGLRenderer();
			renderer4.setSize( window.innerHeight*0.4, window.innerHeight*0.4 );
			document.getElementById("miku4").appendChild( renderer4.domElement );

			var light = new THREE.DirectionalLight( 0xcccccc );
			light.position.set( 1, 1, 1 );
			scene.add( light );

			var helper = new THREE.MMDAnimationHelper();
									helper.configuration.resetPhysicsOnLoop = false;
			var clock = new THREE.Clock();
			var audioParams = { delayTime: 160 * 1 / 30 };

			function degInRad(deg) {
			    return deg * Math.PI / 180;
			}  

			function render() {
				requestAnimationFrame( render );
				var delta = clock.getDelta();
				helper.update( delta );
				manageAnimation(delta)
				renderer1.render( scene, camera1 );
				renderer2.render( scene, camera2 );
				renderer3.render( scene, camera3 );
				renderer4.render( scene, camera4 );
			}

			var loader = new THREE.MMDLoader();
			var audioloader = new THREE.AudioLoader();
			var motionlist = [];
			var voicelist = [];
			var defaultmotionindex = 2;
			var motionindex = defaultmotionindex;
			var motiondurationlist = [];
			var loadmmd = function (modelFile, vmdFiles, soundFiles) {
			    loader.load(modelFile, function (mesh) {
			        scene.add(mesh);
			        listener.position.z = 1;
			        scene.add( listener );
			        // helper.add(mesh);

			        if (vmdFiles && vmdFiles.length !== 0) {
			            var vmdIndex = 0;
			            var loadVmd = function () {
			                var vmdFile = vmdFiles[vmdIndex].file;
			                loader.loadAnimation(vmdFile, mesh, function (animation) {
			                	motionlist.push(animation)
			                    	console.log(vmdFile)
			                    	console.log(animation)
			                    // loader.animationBuilder.build(vmd, mesh);
			                    vmdIndex++;
			                    	console.log(vmdIndex)
			                    	console.log(vmdFiles.length)
			                    if (vmdIndex < vmdFiles.length) {
			                    	console.log("vmdFile")
			                        loadVmd();
			                    } else {
									helper.add( mesh, {
										animation: motionlist[defaultmotionindex],
										physics: true
									} );
									for (var i = 0; i < motionlist.length; i++) {
										motiondurationlist.push(helper.objects.get( mesh ).mixer.clipAction( motionlist[i] )._clip.duration);
									}
									// helper.objects.get( mesh ).mixer.clipAction( motionlist[1] ).play();
			                        // helper.setAnimation(mesh);

			                        // mesh.mixer.stopAllAction();

			                        // helper.setPhysics(mesh);
			                        // helper.unifyAnimationDuration({afterglow: 1.0});

			                        // console.log(mesh.geometry.animations.length);
									render();
			                    }
			                }, onProgress, onError);
			            };
			            loadVmd();
			        }

			        if (soundFiles && soundFiles.length !== 0) {
			        	var voiceindex = 0;
			        	var loadVoice = function() {
			        		var voiceFile = soundFiles[voiceindex];
			        		audioloader.load( voiceFile,
								function ( buffer ) {
									voicelist.push(buffer);
									voiceindex++;
				                    if (voiceindex < soundFiles.length) {
				                        loadVoice();
				                    }
								}
							)
			        	}
				        loadVoice();
			        }
			    }, onProgress, onError);
			};

			var onProgress = function ( xhr ) {
				if ( xhr.lengthComputable ) {
					var percentComplete = xhr.loaded / xhr.total * 100;
					console.log( Math.round(percentComplete, 2) + '% downloaded' );
				}
			};
			var onError = function ( xhr ) {
			};

			function playMMD() {
			    var modelFile = 'miku/arquivo.pmd';

			    var vmdFiles = [
			        {name: 'look', file: 'miku/motion/look.vmd'},
			        {name: 'sleep', file: 'miku/motion/sleep.vmd'},
			        {name: 'stand', file: 'miku/motion/stand.vmd'},
			        {name: 'up', file: 'miku/motion/up.vmd'},
			        {name: 'walk', file: 'miku/motion/walk.vmd'}
			    ];

			    var soundFiles = ["miku/voice/chara1.mp3","miku/voice/chara2.mp3","miku/voice/chara3.mp3","miku/voice/chara4.mp3","miku/voice/chara5.mp3"]

			    loadmmd(modelFile, vmdFiles, soundFiles);
			}
			playMMD();

			var motionStatus = {
				inAnimation: false,
				elapsedTime: 0.0,
				duration: 0.0,
				name: '',
				index: 0
			};
			function manageAnimation(delta){
		        // if(motionindex !== 2) {
					motionStatus.elapsedTime += delta;
					// console.log(motionStatus.elapsedTime+","+motionStatus.duration)
					if ( motionStatus.elapsedTime+delta >= motionStatus.duration-delta ) {
						changeMotion(2)
					}
				// }
			}

			var listener = new THREE.AudioListener();
			var currentaudio;
			// var audio = new THREE.Audio( listener );
			function changeMotion(index){
				var mesh = helper.meshes[ 0 ];
				// helper.remove( mesh );
				// helper.add( mesh, {
				// 	animation: motionlist[index],
				// 	physics: true
				// } );
				helper.objects.get( mesh ).mixer.clipAction( motionlist[motionindex] ).stop();
				helper.objects.get( mesh ).mixer.clipAction( motionlist[index] ).play();
				motionindex = index;
				console.log(currentaudio)
				if(currentaudio !== undefined){
				console.log("undefined")
					helper.remove(currentaudio)
					scene.remove(currentaudio)
					currentaudio=undefined;
				}

				motionStatus.elapsedTime=0.0
				// audio.pause()
				console.log("motiondurationlist:"+motiondurationlist)
				if(index !== 2) {
					console.log("index:"+index)
					var audio = new THREE.Audio( listener ).setBuffer( voicelist[index] );
					audio.setLoop( false );
					helper.add( audio );
					// if(currentaudio !== undefined){
					scene.add( audio );
					// }
					currentaudio=audio;
					// audio.play()
				}

				const duration = motiondurationlist[index];//helper.objects.get( mesh ).mixer.clipAction( motionlist[index] )._clip.duration;
				console.log("duration:"+duration)
				motionStatus.duration = duration;

				// var delta = clock.getDelta();
				// manageAnimation( delta );
			}

			function resizeCanvas() {
				var miku1 = document.getElementById("miku1");
				miku1.style.width = 40 + "vh"; 
				miku1.style.height = 40 + "vh"; 
				miku1.style.position = "absolute";
				miku1.style.left = 40+"vw";
				var miku2 = document.getElementById("miku2");
				miku2.style.width = 40 + "vh"; 
				miku2.style.height = 40 + "vh"; 
				miku2.style.position = "absolute";
				miku2.style.left = 40+"vw";
				miku2.style.top = 60+"vh";
				var miku3 = document.getElementById("miku3");
				miku3.style.width = 40 + "vh"; 
				miku3.style.height = 40 + "vh"; 
				miku3.style.position = "absolute";
				miku3.style.left = 20+"vw";
				miku3.style.top = 30+"vh";
				var miku4 = document.getElementById("miku4");
				miku4.style.width = 40 + "vh"; 
				miku4.style.height = 40 + "vh"; 
				miku4.style.position = "absolute";
				miku4.style.left = 60+"vw";
				miku4.style.top = 30+"vh";

				renderer1.setSize( window.innerHeight*0.4, window.innerHeight*0.4 );
				renderer2.setSize( window.innerHeight*0.4, window.innerHeight*0.4 );
				renderer3.setSize( window.innerHeight*0.4, window.innerHeight*0.4 );
				renderer4.setSize( window.innerHeight*0.4, window.innerHeight*0.4 );
			}
			window.addEventListener('resize', resizeCanvas, false);
			resizeCanvas();




var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition
var SpeechGrammarList = SpeechGrammarList || webkitSpeechGrammarList
var SpeechRecognitionEvent = SpeechRecognitionEvent || webkitSpeechRecognitionEvent

			var recognition = new SpeechRecognition();
var speechRecognitionList = new SpeechGrammarList();
// speechRecognitionList.addFromString(grammar, 1);
recognition.grammars = speechRecognitionList;
//recognition.continuous = false;
recognition.lang = 'zh-CN';
recognition.interimResults = false;
recognition.maxAlternatives = 1;

document.body.onclick = function() {
  recognition.start();
  console.log('Ready to receive a color command.');
}

recognition.onresult = function(event) {
  // The SpeechRecognitionEvent results property returns a SpeechRecognitionResultList object
  // The SpeechRecognitionResultList object contains SpeechRecognitionResult objects.
  // It has a getter so it can be accessed like an array
  // The [last] returns the SpeechRecognitionResult at the last position.
  // Each SpeechRecognitionResult object contains SpeechRecognitionAlternative objects that contain individual results.
  // These also have getters so they can be accessed like arrays.
  // The [0] returns the SpeechRecognitionAlternative at position 0.
  // We then return the transcript property of the SpeechRecognitionAlternative object

  var last = event.results.length - 1;
  var color = event.results[last][0].transcript;
console.log(color)
  // diagnostic.textContent = 'Result received: ' + color + '.';
  // bg.style.backgroundColor = color;
  console.log('Confidence: ' + event.results[0][0].confidence);
}

recognition.onspeechend = function() {
  recognition.stop();
}

recognition.onnomatch = function(event) {
  console.log("I didn't recognise that color.");
}

recognition.onerror = function(event) {
  console.log('Error occurred in recognition: ' + event.error);
}

var jsondata = { "inputText": "天气" }
// fetch('http://localhost/talk/talk.php', {
//      method: 'POST',
//      // headers: {'Content-Type': 'application/json'},
//      // mode: 'cors',
//      // credentials:'include',
//      body: JSON.stringify(jsondata)
//     }).then( function(response) {
//         console.log("response")
//         console.log(response)
//       if(response.ok) {
//       	response.text().then(function(json){
//         console.log(json)
//     })
//       }
//     }).catch(function(response){
//     })

    $.post("http://localhost/talk/talk.php", jsondata,function(argument) {
    console.log(argument);
    console.log(JSON.parse(argument)["results"][0]["values"]["text"]);
});

var json = {"intent":{"actionName":"","code":10008,"intentName":"","parameters":{"date":"","city":"上海"}},"results":[{"groupType":1,"resultType":"text","values":{"text":"上海:周三 11月14日,多云 东北风微风,最低气温13度，最高气温18度"}}]}
parseJson(json);
function parseJson(json) {
speak(json["results"][0]["values"]["text"])
}
// speak("初音未来")
function speak(text) {
	// var utterThis = new window.SpeechSynthesisUtterance(text);
	var msg = new SpeechSynthesisUtterance();
				msg.pitch = 1.5;
				msg.lang = 'zh-CN';
				msg.text = text;
window.speechSynthesis.speak(msg);
}

		</script>
	</body>
</html>